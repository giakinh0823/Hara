{% extends 'Base/index.html' %}
{% load static %}
{% load Sum %}
{% load imageYoutube %}
{% block body %}
    <div class="product_detail" style="padding: 40px 0">
        <div class="container">
            <div class="row row-cols-1 row-cols-lg-2 mb-5">
                <div class="col col-lg-7 mb-5">
                    <div class="product_detail-carousel">
                        <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-indicators carousel-indicators-product-details">
                                {% if images or videos %}
                                    {% for image in images %}
                                        <div>
                                            {% if forloop.counter0 == 0 %}
                                                <button type="button" data-bs-target="#carouselExampleIndicators"
                                                        data-bs-slide-to="0"
                                                        class="product_detail-button active" aria-current="true"
                                                        aria-label="Slide 1"
                                                        style="background-image: url('{{ image.image.url }}');"
                                                >
                                                </button>
                                            {% else %}
                                                <button type="button" data-bs-target="#carouselExampleIndicators"
                                                        data-bs-slide-to="{{ forloop.counter0 }}"
                                                        class="product_detail-button" aria-current="true"
                                                        aria-label="Slide 1"
                                                        style="background-image: url('{{ image.image.url }}');"
                                                >
                                                </button>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                    {% for video in videos %}
                                        {% if not images and forloop.counter0 == 0 %}
                                            <div>
                                                <button type="button" data-bs-target="#carouselExampleIndicators"
                                                        data-bs-slide-to="{{ forloop.counter|Sum:images }}"
                                                        class="product_detail-button active" aria-current="true"
                                                        aria-label="Slide 1"
                                                        style="background-image: url('http://i3.ytimg.com/vi/{{ video.video|imageYoutube }}/maxresdefault.jpg');"
                                                >
                                                </button>
                                            </div>
                                        {% else %}
                                            <div>
                                                <button type="button" data-bs-target="#carouselExampleIndicators"
                                                        data-bs-slide-to="{{ forloop.counter|Sum:images }}"
                                                        class="product_detail-button" aria-current="true"
                                                        aria-label="Slide 1"
                                                        style="background-image: url('http://i3.ytimg.com/vi/{{ video.video|imageYoutube }}/maxresdefault.jpg');"
                                                >
                                                </button>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <div>
                                        <button type="button" data-bs-target="#carouselExampleIndicators"
                                                data-bs-slide-to="1"
                                                class="product_detail-button" aria-current="true" aria-label="Slide 1"
                                                style="background-image: url('{{ product_detail.img.url }}');"
                                        >
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="carousel-inner">
                                {% if images or videos %}
                                    {% for image in images %}
                                        {% if forloop.counter0 == 0 %}
                                            <div class="carousel-item active">
                                                <img src="{{ image.image.url }}" class="d-block w-100 h-100"
                                                     alt="{{ product_detail.title }}">
                                            </div>
                                        {% else %}
                                            <div class="carousel-item">
                                                <img src="{{ image.image.url }}" class="d-block w-100 h-100"
                                                     alt="{{ product_detail.title }}">
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    {% for video in videos %}
                                        {% if not images and forloop.counter0 == 0 %}
                                            <div class="carousel-item active">
                                                <iframe class="d-block w-100 h-100"
                                                        src="{{ video.video }}"></iframe>
                                            </div>
                                        {% else %}
                                            <div class="carousel-item">
                                                <iframe class="d-block w-100 h-100"
                                                        src="{{ video.video }}"></iframe>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <div class="carousel-item active">
                                        <img src="{{ product_detail.img.url }}" class="d-block w-100 h-100"
                                             alt="{{ product_detail.title }}">
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col col-lg-5">
                    <div class="d-flex flex-column">
                        <div class="mt-2" style="color: #34ca96">KINH PHI</div>
                        <div class="product_detail-header mt-3">
                            <h3>{{ product_detail.title }}</h3>
                        </div>
                        <div class="product_detail-caption">
                            <p>{{ product_detail.caption }}</p>
                        </div>
                        <div class="product_user mt-3 d-flex">
                            <div class="product_user-image">
                                <img src="{{ profile_detail.image.url }}" alt="" class="product_user-img">
                            </div>
                            <div class="product_user-name ms-3">
                                {% if request.user == profile_detail.user %}
                                    <a href="{{ profile_detail.get_absolute_url }}" class="text-decoration-none"
                                       style="color: #1b1b1b"><p
                                            style="font-size: 18px;font-weight:600 ;margin: 0">{{ product_detail.user.get_full_name }}</p>
                                    </a>
                                {% else %}
                                    <a href="{{ profile_detail.get_absolute_url_detail }}" class="text-decoration-none"
                                       style="color: #1b1b1b"><p
                                            style="font-size: 18px;font-weight:600 ;margin: 0">{{ product_detail.user.get_full_name }}</p>
                                    </a>
                                {% endif %}
                                <p>9 Campaigns | {{ profile_detail.address }}</p>
                            </div>
                        </div>
                        <div style="padding: 0 10px">
                            <div class="mt-3">
                                <div class="d-flex align-items-center">
                                    <div class="product_detail-price">
                                        <p style="font-size:20px; font-weight: 600">
                                            ${{ product_detail.price|floatformat:2 }}</p>
                                    </div>
                                    <div class="product_detail-backers ms-auto">
                                        <p style="font-size:16px; font-weight: 300">1.678 người ủng hộ</p>
                                    </div>
                                </div>
                                <div class="">
                                    <div class="progress card-progress">
                                        <div class="progress-bar" role="progressbar"
                                             style="width: {{ product_detail.percent|floatformat:2 }}%"
                                             aria-valuenow="{{ product_detail.percent|floatformat:2 }}"
                                             aria-valuemin="0"
                                             aria-valuemax="100"></div>
                                    </div>
                                    <div class="d-flex mt-2">
                                        <div>
                                            <p>{{ product_detail.percent|floatformat:2 }}%</p>
                                        </div>
                                        <div class="ms-auto">
                                            <p> {{ product_detail.created_at }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3 d-flex">
                                    <a href="{% url 'product:checkout_loading' slug=product_detail.slug %}"
                                       type="button" class="button-primary">
                                        ĐẦU TƯ NGAY
                                    </a>
                                    <button class="ms-3 button-secondary d-flex align-items-center">
                                        <span><i class="bi bi-heart"></i></span>
                                        <span class="ms-2">THEO DÕI</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr>
        <div class="container">
            <div class="row row-cols-1 row-cols-lg-2 mb-5">
                <div class="col col-lg-7">
                    <ul class="nav nav-pills mb-5" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link product_detail-active active" id="pills-home-tab"
                                    data-bs-toggle="pill"
                                    data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home"
                                    aria-selected="true">STORY
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link product_detail-active" id="pills-profile-tab" data-bs-toggle="pill"
                                    data-bs-target="#pills-profile" type="button" role="tab"
                                    aria-controls="pills-profile"
                                    aria-selected="false">COMMENT
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link product_detail-active" id="pills-contact-tab" data-bs-toggle="pill"
                                    data-bs-target="#pills-contact" type="button" role="tab"
                                    aria-controls="pills-contact"
                                    aria-selected="false">FAQ
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="pills-tabContent">
                        <div class="tab-pane fade show active" id="pills-home" role="tabpanel"
                             aria-labelledby="pills-home-tab">
                            <div>
                                <div class="col">
                                    <ul class="product_detail-list">
                                        <li class="product_detail-item">
                                            <img src="{% static 'img/banner3.jpg' %}" alt="" style="width: 100%">
                                        </li>
                                        <li class="product_detail-item">
                                            <img src="{% static 'img/banner4.jpg' %}" alt="" style="width: 100%">
                                        </li>
                                        <li class="product_detail-item">
                                            <img src="{% static 'img/banner5.jpg' %}" alt="" style="width: 100%">
                                        </li>
                                        <li class="product_detail-item">
                                            <img src="{% static 'img/blog1.jpg' %}" alt="" style="width: 100%">
                                        </li>
                                        <li class="product_detail-item">
                                            <img src="{% static 'img/blog2.jpg' %}" alt="" style="width: 100%">
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="pills-profile" role="tabpanel"
                             aria-labelledby="pills-profile-tab">
                            {% if order or product_detail.user == request.user %}
                                <div class="comment">
                                    <div class="form-comment row">
                                        <label for="id_comment" class="form-label" style="font-size: 18px; padding: 0">Post
                                            a comment</label>
                                        <textarea type="area" id='id_comment' required class="form-control"
                                                  rows="4"></textarea>
                                        <button class="button-secondary mt-3 ms-auto" id="comment-button"
                                                style="width:fit-content">POST
                                        </button>
                                    </div>
                                </div>
                            {% endif %}
                            <div class="comment-content">
                                <div class="col">
                                    <ul class="comment_content-list">
                                        {% if comments %}
                                            {% for comment in comments %}
                                                <li class="comment_content-item mb-3" style="display:none">
                                                    <div class="comment-user d-flex">
                                                        <div class="comment-user-image">
                                                            <img src="{{ comment.profile.image.url }}" alt="..."
                                                                 class="comment-user-img">
                                                        </div>
                                                        <div class="comment-user-content ms-3">
                                                            {% if user == comment.user %}
                                                                <a class="text-decoration-none"
                                                                   href="{{ profile_detail.get_absolute_url }}"
                                                                   style="font-weight: 500; margin:0; color: #1b1b1b"
                                                                   id="comment_user">{{ comment.user.get_full_name }}</a>
                                                            {% else %}
                                                                <a class="text-decoration-none"
                                                                   href="{{ comment.profile.get_absolute_url_detail }}"
                                                                   style="font-weight: 500; margin:0; color: #1b1b1b"
                                                                   id="comment_user">{{ comment.user.get_full_name }}</a>
                                                            {% endif %}
                                                            <p class="mt-0"
                                                               id="comment_content_label">{{ comment.comment }}</p>
                                                            <div class="d-flex">
                                                                <div>
                                                                    <button class="comment-icon comment-like"><i
                                                                            class="bi bi-hand-thumbs-up"></i></button>
                                                                    <span>9</span>
                                                                </div>
                                                                <div class="ms-2">
                                                                    <button class="comment-icon comment-dislike"><i
                                                                            class="bi bi-hand-thumbs-down"></i></button>
                                                                    <span>9</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>
                                            {% endfor %}

                                        {% endif %}
                                    </ul>
                                    <div class="row text-center">
                                        <div>
                                            <button class="button-primary button-load-more">Load more</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="pills-contact" role="tabpanel"
                             aria-labelledby="pills-contact-tab">
                            <div class="faq col ps-3">
                                <div class="faq-header">
                                    <h5 class="display-6" style="font-size: 24px">Frequently Asked Questions</h5>
                                </div>
                                <div class="faq-content mt-4">
                                    <ul class="faq_list">
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">Is delivery
                                                guaranteed?</p>
                                            <p class="faq_item-caption">Yes, absolutely! While Indiegogo doesn't
                                                guarantee delivery of products, we, as Rolling Square do. If you
                                                contribute to one of our perks you will receive the product. Simple as
                                                that. This is our eighth campaign and we have already delivered to
                                                hundreds of thousands of backers, so you can count on our
                                                experience.</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">What's your support email
                                                address?</p>
                                            <p class="faq_item-caption">You can reach us at support@rollingsqua.re! We
                                                receive a lot of emails but usually we will reply within 24 working
                                                hours. Make sure to avoid sending followup emails, as they will bring
                                                your ticket back to the end of the "pile", and each and every email is
                                                replied to anyway. Thank you :)</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">I pledged to multiple
                                                perks, will I save on shipping costs?</p>
                                            <p class="faq_item-caption">If you pledge to multiple perks, we will combine
                                                them in a single shipment, so it's possible that you will save on
                                                shipping costs. The difference will be calculated precisely towards the
                                                end of the campaign and you will receive a credit for the amount.</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">Can I invest and are you
                                                looking for agents and distributors?</p>
                                            <p class="faq_item-caption">We are always excited to speak with anyone that
                                                believes in our products. If you are interested in getting involved as
                                                an investor, agent, or distributor, email us at info@ferrarisgroup.ch
                                                and let’s start talking!</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">Is shipping tracked?</p>
                                            <p class="faq_item-caption">Yes, all shipping methods are tracked!</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">I moved. Can I change my
                                                address?</p>
                                            <p class="faq_item-caption">Yes, you can change your address if your
                                                contribution status is "Placed". If your status is "Locked", there's
                                                still a chance that you can change it, since any update is possible
                                                until we ship your order out. To change it, please visit your orders's
                                                page by logging in at https://backer.tools/login. If it shows that your
                                                order is either "Exported" or "Shipped", it's unfortunately too
                                                late.</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">Is it possible to request
                                                a refund?</p>
                                            <p class="faq_item-caption">If you have changed your mind, you can request a
                                                refund if your order status is "Placed". If your order is "Locked",
                                                please contact support@rollingsqua.re and we will try to intercept your
                                                package. If it's "Shipped", you will need to wait until you receive the
                                                package, then you can ship the package back to us. Once received, we
                                                will send you the refund.</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">After I received the
                                                product, can I return it for a refund?</p>
                                            <p class="faq_item-caption">Yes, you will have 30 days after the day your
                                                package has been delivered to contact support@rollingsqua.re and
                                                initiate the return process.</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">Will I need to pay
                                                VAT?</p>
                                            <p class="faq_item-caption">In general, no. Although, due to the many
                                                countries and regulations, we can't guarantee it, to be sure, you should
                                                check with the local customs. Orders larger than 5 units are more likely
                                                to incur in importation expenses. The shipments will come from one of
                                                our warehouses, either in China, US or EU.</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">Can I buy a larger
                                                quantity?</p>
                                            <p class="faq_item-caption">If you are interested in making a bulk order
                                                (min. 100 units), please contact info@ferrarisgroup.ch and we will send
                                                you a quotation right away.</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">Is EDGE covered by a
                                                warranty?</p>
                                            <p class="faq_item-caption"></p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px"></p>
                                            <p class="faq_item-caption">Absolutely! Our warranty lasts for 2 years, and
                                                is valid worldwide.</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">Does the EDGE Light need
                                                a cable to work?</p>
                                            <p class="faq_item-caption">The EDGE Light also has a battery, so a cable
                                                isn't needed all the time. However, it will need to be charged, and it
                                                can reach a higher brightness if used while plugged in.</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">What's the charging speed
                                                of the EDGE Wireless Charger?</p>
                                            <p class="faq_item-caption">The EDGE Wireless Charger can charge at 15W max.
                                                Please note that iPhone is limited by Apple to charge at 7.5W on third
                                                party wireless chargers</p>
                                        </li>
                                        <li class="faq_item mb-3">
                                            <p class="faq_item-header" style="font-size: 18px">Can I use my own MagSafe
                                                charger with the EDGE Mount?</p>
                                            <p class="faq_item-caption">Absolutely, you will just need to add a metal
                                                plate to the back of the MagSafe.</p>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col col-lg-5">
                    <div class="d-flex flex-column align-items-center mt-5 pt-5">
                        {% for product in list_products %}
                            <div class="col-8 mb-2 list-products-content" style="min-height: 300px">
                                <div class="home-card">
                                    <div class="card w-100 home-card-content" style="width: 18rem;">
                                        {% if product.img %}
                                            <img loading="lazy" src="{{ product.img.url }}" class="card-img-top"
                                                 alt="">
                                        {% else %}
                                            <img loading="lazy" src="{% static 'img/iphone-2.jpg' %}"
                                                 class="card-img-top" alt="">
                                        {% endif %}
                                        <div class="card-body d-flex flex-column">
                                            <div class="card-type mb-2">
                                                <div class="card-type-header me-auto">KINH PHI</div>
                                                <div class="card-type-icon">
                                                    <button class="card-type-btn">
                                                        <i class="bi bi-heart card-type-btn-icon"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <h5 class="card-title"><a href="{{ product.get_absolute_url }}"
                                                                      class="card-title-link">{{ product.title }}</a>
                                            </h5>
                                            <p class="card-text card-text-caption">{{ product.caption }}</p>
                                            <div class="card-category">
                                                <a href="" class="card-category-link">{{ product.category }}</a>
                                            </div>
                                            <div class="card-price d-flex">
                                                <span class="card-price-bold me-auto font-bold">${{ product.price|floatformat:2 }}</span>
                                                <span class="card-price-percent">{{ product.percent|floatformat:2 }}%</span>
                                            </div>
                                            <div class="mb-2 mt-1">
                                                <div class="progress card-progress">
                                                    <div class="progress-bar" role="progressbar"
                                                         style="width: {{ product.percent|floatformat:2 }}%"
                                                         aria-valuenow="{{ product.percent|floatformat:2 }}"
                                                         aria-valuemin="0"
                                                         aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-clock">
                                            <span class="card-lock-label"><i
                                                    class="bi bi-clock"></i> 26 ngày còn lại</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const endpoint = 'ws://127.0.0.1:8000/ws/comment/{{ product_detail.slug }}/'
        const socket = new WebSocket(endpoint)

        socket.onopen = function (e) {
            console.log("open", e);
        }
        socket.onmessage = function (e) {
            console.log("message", e)
            const data = JSON.parse(e.data);
            console.log(data)
            document.querySelector(".comment_content-list").innerHTML = (`<li class="comment_content-item mb-3">
                                                    <div class="comment-user d-flex">
                                                        <div class="comment-user-image">
                                                            <img src="${data.avatar}" alt="..."
                                                                 class="comment-user-img">
                                                        </div>
                                                        <div class="comment-user-content ms-3">
                                                             <a class="text-decoration-none" href="${data.url}"
                                                                   style="font-weight: 500; margin:0; color: #1b1b1b"
                                                                   id="comment_user">${data.name}</a>
                                                            <p class="mt-0"
                                                               id="comment_content_label">${data.comment}</p>
                                                            <div class="d-flex">
                                                                <div>
                                                                    <button class="comment-icon comment-like"><i
                                                                            class="bi bi-hand-thumbs-up"></i></button>
                                                                    <span>9</span>
                                                                </div>
                                                                <div class="ms-2">
                                                                    <button class="comment-icon comment-dislike"><i
                                                                            class="bi bi-hand-thumbs-down"></i></button>
                                                                    <span>9</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </li>`) + document.querySelector(".comment_content-list").innerHTML

        }
        socket.onerror = function (e) {
            console.log("error", e)
        }
        socket.onclose = function (e) {
            console.log("close", e)
        }

        const endpointUserComment = 'ws://127.0.0.1:8000/ws/notify/{{ product_detail.user }}/'
        const socketUserComment = new WebSocket(endpointUserComment)

        document.getElementById("comment-button").onclick = (e) => {
            const comment = document.querySelector("#id_comment").value;

            if (comment !== '') {
                {% if product_detail.user == request.user %}
                {% else %}
                    socketUserComment.send(JSON.stringify({
                        'comment': "{{ user.get_full_name }} đã đánh sản phẩm {{ product_detail.title }}",
                        'username': "{{ product_detail.user }}",
                        'room': "{{ product_detail.user }}",
                        'link': "{{ product_detail.get_absolute_url }}",
                        'person': "{{ user }}",
                    }))
                {% endif %}

                socket.send(JSON.stringify({
                    'comment': comment,
                    'username': "{{ user }}",
                    'name': "{{ user.get_full_name }}",
                    'room': "{{ product_detail.slug }}",
                    'person': "{{ product_detail.user }}",
                    'avatar': "{{ profile_user.image.url }}",
                    "link": "{{ product_detail.get_absolute_url }}",
                }))
                document.querySelector("#id_comment").value = ''
            } else {

            }
        }


        if ($(".comment_content-item").length < 9) {
            $(".button-load-more").hide();
        }
        $(".comment_content-item").slice(0, 7).show();
        $(".button-load-more").on("click", () => {
            $(".comment_content-item:hidden").slice(0, 7).show();
            if ($(".comment_content-item:hidden").length === 0) {
                $(".button-load-more").fadeOut()
            }
        })


    </script>
{% endblock body %}